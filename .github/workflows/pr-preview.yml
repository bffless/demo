name: PR Demo Preview

on:
  pull_request:
    branches: ['*']

permissions:
  contents: read
  pull-requests: write

jobs:
  test-and-preview:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Run tests with coverage
        run: pnpm test:coverage

      - name: Download production coverage
        id: download-coverage
        uses: bffless/download-artifact@v1
        continue-on-error: true
        with:
          alias: coverage-production
          source-path: coverage
          output-path: ./coverage-production
          api-url: ${{ vars.ASSET_HOST_URL }}
          api-key: ${{ secrets.ASSET_HOST_KEY }}

      - name: Install Playwright browsers
        run: pnpm exec playwright install chromium

      - name: Build Demo
        run: pnpm build

      - name: Capture PR screenshots
        run: pnpm test:vrt

      - name: Download production screenshots
        id: download-screenshots
        uses: bffless/download-artifact@v1
        continue-on-error: true
        with:
          alias: screenshots-production
          source-path: screenshots
          output-path: ./screenshots-production
          api-url: ${{ vars.ASSET_HOST_URL }}
          api-key: ${{ secrets.ASSET_HOST_KEY }}

      - name: Compare screenshots
        id: compare-screenshots
        if: steps.download-screenshots.outcome == 'success'
        continue-on-error: true
        run: pnpm compare:screenshots --baseline ./screenshots-production --current ./screenshots --diff ./screenshot-diffs --output ./vrt-report.json

      - name: Upload PR screenshots
        uses: bffless/upload-artifact@v1
        with:
          path: screenshots
          api-url: ${{ vars.ASSET_HOST_URL }}
          api-key: ${{ secrets.ASSET_HOST_KEY }}
          alias: screenshots-pr-${{ github.event.pull_request.number }}
          description: 'Screenshots for PR #${{ github.event.pull_request.number }}'
          summary-title: PR Screenshots Upload

      - name: Upload screenshot diffs
        if: steps.compare-screenshots.outcome == 'failure'
        uses: bffless/upload-artifact@v1
        with:
          path: screenshot-diffs
          api-url: ${{ vars.ASSET_HOST_URL }}
          api-key: ${{ secrets.ASSET_HOST_KEY }}
          alias: screenshot-diffs-pr-${{ github.event.pull_request.number }}
          description: 'Screenshot diffs for PR #${{ github.event.pull_request.number }}'
          summary-title: Screenshot Diffs Upload

      - name: Get production SHA
        id: prod-sha
        run: echo "sha=$(git rev-parse origin/main)" >> $GITHUB_OUTPUT

      - name: Compare coverage and VRT, comment on PR
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_SHA: ${{ github.event.pull_request.head.sha }}
          PROD_SHA: ${{ steps.prod-sha.outputs.sha }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          SCREENSHOTS_DOWNLOAD_STATUS: ${{ steps.download-screenshots.outcome }}
          VRT_COMPARISON_STATUS: ${{ steps.compare-screenshots.outcome }}
        with:
          script: |
            const fs = require('fs');
            const prNumber = process.env.PR_NUMBER;
            const prSha = process.env.PR_SHA;
            const prodSha = process.env.PROD_SHA;
            const repoOwner = process.env.REPO_OWNER;
            const repoName = process.env.REPO_NAME;
            const screenshotsDownloadStatus = process.env.SCREENSHOTS_DOWNLOAD_STATUS;
            const vrtComparisonStatus = process.env.VRT_COMPARISON_STATUS;

            // BFFLESS URL base
            const bfflessBase = 'https://admin.docs.bffless.app';

            // Read PR coverage
            let prCoverage = null;
            try {
              const prSummary = JSON.parse(fs.readFileSync('./coverage/coverage-summary.json', 'utf8'));
              prCoverage = prSummary.total.lines.pct;
            } catch (e) {
              console.log('Could not read PR coverage:', e.message);
            }

            // Read production coverage
            let prodCoverage = null;
            try {
              const prodSummary = JSON.parse(fs.readFileSync('./coverage-production/coverage-summary.json', 'utf8'));
              prodCoverage = prodSummary.total.lines.pct;
            } catch (e) {
              console.log('Could not read production coverage:', e.message);
            }

            // Build coverage section
            let body = '## Coverage Report\n\n';

            if (prCoverage !== null) {
              body += `**PR Coverage:** ${prCoverage.toFixed(2)}%\n\n`;

              if (prodCoverage !== null) {
                const diff = prCoverage - prodCoverage;
                const emoji = diff >= 0 ? 'üìà' : 'üìâ';
                const sign = diff >= 0 ? '+' : '';
                body += `**Production Coverage:** ${prodCoverage.toFixed(2)}%\n\n`;
                body += `**Change:** ${emoji} ${sign}${diff.toFixed(2)}%\n`;
              } else {
                body += '_No production coverage baseline found. This PR will establish the baseline once merged._\n';
              }
            } else {
              body += '_Could not read coverage report._\n';
            }

            // Build VRT section
            body += '\n---\n\n## Visual Regression Report\n\n';

            if (screenshotsDownloadStatus !== 'success') {
              body += '_No production screenshot baseline found. This PR will establish the baseline once merged._\n';
            } else {
              // Read VRT report
              let vrtReport = null;
              try {
                vrtReport = JSON.parse(fs.readFileSync('./vrt-report.json', 'utf8'));
              } catch (e) {
                console.log('Could not read VRT report:', e.message);
              }

              if (vrtReport) {
                const { summary, results } = vrtReport;
                const passed = summary.passed;
                const total = summary.total;
                const failed = summary.failed;
                const newScreenshots = summary.new;
                const missing = summary.missing;

                if (failed === 0 && missing === 0 && newScreenshots === 0) {
                  body += `‚úÖ **${passed}/${total}** screenshots passed\n\n`;
                } else if (failed === 0 && missing === 0 && newScreenshots > 0) {
                  if (passed > 0) {
                    body += `‚úÖ **${passed}/${total - newScreenshots}** screenshots passed | ${newScreenshots} new\n\n`;
                  } else {
                    body += `üÜï **${newScreenshots}** new screenshots (no baseline to compare)\n\n`;
                  }
                } else {
                  body += `‚ùå **${passed}/${total - newScreenshots}** screenshots passed`;
                  if (failed > 0) body += ` | ${failed} failed`;
                  if (missing > 0) body += ` | ${missing} missing`;
                  if (newScreenshots > 0) body += ` | ${newScreenshots} new`;
                  body += '\n\n';
                }

                // Build results table
                body += '| Screenshot | Status | Diff % |\n';
                body += '|------------|--------|--------|\n';

                for (const result of results) {
                  const statusEmoji = result.status === 'pass' ? '‚úÖ' :
                                       result.status === 'fail' ? '‚ùå' :
                                       result.status === 'new' ? 'üÜï' : '‚ö†Ô∏è';
                  const diffPct = result.diffPercentage !== undefined ?
                                  `${result.diffPercentage.toFixed(3)}%` : '-';
                  body += `| ${result.name} | ${statusEmoji} ${result.status} | ${diffPct} |\n`;
                }

                // Add collapsible sections for failures with side-by-side comparison
                const failures = results.filter(r => r.status === 'fail');
                if (failures.length > 0) {
                  body += '\n### Failed Screenshots\n\n';
                  for (const failure of failures) {
                    // BFFLESS URL pattern: /public/{owner}/{repo}/commits/{sha}/{path}
                    const prodUrl = `${bfflessBase}/public/${repoOwner}/${repoName}/commits/${prodSha}/screenshots/${failure.name}`;
                    const prUrl = `${bfflessBase}/public/${repoOwner}/${repoName}/commits/${prSha}/screenshots/${failure.name}`;
                    const diffUrl = `${bfflessBase}/public/${repoOwner}/${repoName}/commits/${prSha}/screenshot-diffs/diff-${failure.name}`;

                    body += `<details>\n`;
                    body += `<summary>‚ùå ${failure.name} (${failure.diffPercentage.toFixed(3)}% diff)</summary>\n\n`;
                    body += `| Production | PR | Diff |\n`;
                    body += `|------------|-----|------|\n`;
                    body += `| ![prod](${prodUrl}) | ![pr](${prUrl}) | ![diff](${diffUrl}) |\n\n`;
                    body += `</details>\n\n`;
                  }
                }
              } else {
                body += '_Could not read visual regression report._\n';
              }
            }

            body += '\n---\n_Generated by [BFFless](https://bffless.app) coverage and VRT comparison_';

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('## Coverage Report')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body,
              });
            }

      - name: Upload build preview
        uses: bffless/upload-artifact@v1
        with:
          path: dist
          api-url: ${{ vars.ASSET_HOST_URL }}
          api-key: ${{ secrets.ASSET_HOST_KEY }}
          alias: preview
          base-path: /dist
          description: 'Demo preview for PR #${{ github.event.pull_request.number }}'
          summary-title: Demo Preview Summary
