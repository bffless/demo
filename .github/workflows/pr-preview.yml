name: PR Demo Preview

on:
  pull_request:
    branches: ['*']

permissions:
  contents: read
  pull-requests: write

jobs:
  test-and-preview:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Run tests with coverage
        run: pnpm test:coverage

      - name: Download production coverage
        id: download-coverage
        uses: bffless/download-artifact@v1
        continue-on-error: true
        with:
          alias: coverage-production
          source-path: coverage
          output-path: ./coverage-production
          api-url: ${{ vars.ASSET_HOST_URL }}
          api-key: ${{ secrets.ASSET_HOST_KEY }}

      - name: Compare coverage and comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read PR coverage
            let prCoverage = null;
            try {
              const prSummary = JSON.parse(fs.readFileSync('./coverage/coverage-summary.json', 'utf8'));
              prCoverage = prSummary.total.lines.pct;
            } catch (e) {
              console.log('Could not read PR coverage:', e.message);
            }

            // Read production coverage
            let prodCoverage = null;
            try {
              const prodSummary = JSON.parse(fs.readFileSync('./coverage-production/coverage-summary.json', 'utf8'));
              prodCoverage = prodSummary.total.lines.pct;
            } catch (e) {
              console.log('Could not read production coverage:', e.message);
            }

            // Build comment
            let body = '## Coverage Report\n\n';

            if (prCoverage !== null) {
              body += `**PR Coverage:** ${prCoverage.toFixed(2)}%\n\n`;

              if (prodCoverage !== null) {
                const diff = prCoverage - prodCoverage;
                const emoji = diff >= 0 ? 'ðŸ“ˆ' : 'ðŸ“‰';
                const sign = diff >= 0 ? '+' : '';
                body += `**Production Coverage:** ${prodCoverage.toFixed(2)}%\n\n`;
                body += `**Change:** ${emoji} ${sign}${diff.toFixed(2)}%\n`;
              } else {
                body += '_No production coverage baseline found. This PR will establish the baseline once merged._\n';
              }
            } else {
              body += '_Could not read coverage report._\n';
            }

            body += '\n---\n_Generated by [BFFless](https://bffless.app) coverage comparison_';

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('## Coverage Report')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body,
              });
            }

      - name: Build Demo
        run: pnpm build

      - name: Upload build preview
        uses: bffless/upload-artifact@v1
        with:
          path: dist
          api-url: ${{ vars.ASSET_HOST_URL }}
          api-key: ${{ secrets.ASSET_HOST_KEY }}
          alias: preview
          base-path: /dist
          description: 'Demo preview for PR #${{ github.event.pull_request.number }}'
          summary-title: Demo Preview Summary
